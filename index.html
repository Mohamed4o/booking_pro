<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointment Booking System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- استيراد React و ReactDOM. يتم استخدامهما هنا كمتغيرات عالمية -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    @keyframes slide-down {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }
    .animate-slide-down {
      animation: slide-down 0.5s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center">
  <div id="root" class="w-full max-w-6xl"></div>

  <script type="module">
    // استيراد Firebase كـ ES Modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDocs, where, setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // تعيين مستوى تسجيل الدخول لتصحيح الأخطاء
    setLogLevel('debug');

    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // تهيئة متغيرات Firebase العالمية
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : null);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function App() {
      // حالات React لإدارة واجهة المستخدم
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [bookings, setBookings] = useState([]);
      const [form, setForm] = useState({ name: '', email: '', phone: '', date: '', time: '' });
      const [editingBookingId, setEditingBookingId] = useState(null);
      const [userId, setUserId] = useState(null);
      const [message, setMessage] = useState(null);
      const [showConfirmModal, setShowConfirmModal] = useState(false);
      const [bookingToDeleteId, setBookingToDeleteId] = useState(null);
      const [currentView, setCurrentView] = useState('form');

      // تأثير لمصادقة المستخدم عند التحميل الأولي
      useEffect(() => {
        const authenticate = async () => {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Firebase Auth Error:", error);
          }
        };
        authenticate();

        const unsubscribe = onAuthStateChanged(auth, user => {
          if (user) {
            setUserId(user.uid);
            console.log("User ID:", user.uid);
          } else {
            setUserId(null);
            console.log("User is not signed in.");
          }
        });
        return () => unsubscribe();
      }, []);

      // تأثير لإنشاء بيانات الاعتماد الافتراضية للمسؤول
      useEffect(() => {
        const createAdminCredentials = async () => {
          if (userId) {
            const credentialsCollection = collection(db, `artifacts/${appId}/public/data/adminCredentials`);
            const q = query(credentialsCollection, where("username", "==", "admin"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
              await addDoc(credentialsCollection, {
                username: 'admin',
                password: '12345'
              });
              console.log("Default admin credentials created.");
            }
          }
        };
        createAdminCredentials();
      }, [userId]);

      // تأثير لجلب الحجوزات في الوقت الفعلي
      useEffect(() => {
        if (isLoggedIn && userId) {
          const collectionPath = `artifacts/${appId}/users/${userId}/bookings`;
          const q = query(collection(db, collectionPath));
          
          const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const bookingsArray = [];
            querySnapshot.forEach((doc) => {
              bookingsArray.push({ id: doc.id, ...doc.data() });
            });
            // فرز الحجوزات حسب التاريخ والوقت
            bookingsArray.sort((a, b) => {
              const dateA = new Date(`${a.date}T${a.time}`);
              const dateB = new Date(`${b.date}T${b.time}`);
              return dateA - dateB;
            });
            setBookings(bookingsArray);
          }, (error) => {
            console.error("Error fetching real-time bookings: ", error);
          });
          return () => unsubscribe();
        }
      }, [isLoggedIn, userId]);

      // معالجة تسجيل الدخول
      const handleLogin = async (e) => {
        e.preventDefault();
        const credentialsCollection = collection(db, `artifacts/${appId}/public/data/adminCredentials`);
        const q = query(credentialsCollection, where("username", "==", username), where("password", "==", password));
        
        try {
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            setIsLoggedIn(true);
            setCurrentView('dashboard');
            showMessage('Login successful!', 'success');
          } else {
            showMessage('Invalid login credentials.', 'error');
          }
        } catch (error) {
          console.error("Login failed:", error);
          showMessage('Login failed due to an error.', 'error');
        }
      };

      // معالجة إرسال الحجز
      const handleBookingSubmit = async (e) => {
        e.preventDefault();
        if (!userId) {
          console.error("User not authenticated.");
          showMessage('User not authenticated.', 'error');
          return;
        }
        const collectionPath = `artifacts/${appId}/users/${userId}/bookings`;

        try {
          if (editingBookingId) {
            const docRef = doc(db, collectionPath, editingBookingId);
            await updateDoc(docRef, form);
            showMessage('Booking updated successfully!', 'success');
            setEditingBookingId(null);
          } else {
            await addDoc(collection(db, collectionPath), form);
            showMessage('Booking added successfully!', 'success');
          }
          setForm({ name: '', email: '', phone: '', date: '', time: '' });
        } catch (error) {
          console.error("Error submitting booking:", error);
          showMessage('An error occurred while saving the booking.', 'error');
        }
      };

      // عرض رسائل التنبيه
      const showMessage = (text, type) => {
        setMessage({ text, type });
        setTimeout(() => {
          setMessage(null);
        }, 3000);
      };

      // معالجة حذف الحجز
      const handleDeleteClick = (id) => {
        setBookingToDeleteId(id);
        setShowConfirmModal(true);
      };

      const handleDeleteConfirm = async () => {
        if (bookingToDeleteId && userId) {
          const collectionPath = `artifacts/${appId}/users/${userId}/bookings`;
          try {
            await deleteDoc(doc(db, collectionPath, bookingToDeleteId));
            showMessage('Booking deleted successfully!', 'success');
          } catch (error) {
            console.error("Error deleting booking:", error);
            showMessage('An error occurred while deleting the booking.', 'error');
          } finally {
            setShowConfirmModal(false);
            setBookingToDeleteId(null);
          }
        }
      };

      // معالجة تعديل الحجز
      const handleEdit = (booking) => {
        setEditingBookingId(booking.id);
        setForm({
          name: booking.name,
          email: booking.email,
          phone: booking.phone,
          date: booking.date,
          time: booking.time,
        });
        setCurrentView('form');
      };

      // عرض واجهة المستخدم بناءً على الحالة
      const renderView = () => {
        if (isLoggedIn && currentView === 'dashboard') {
          return React.createElement(
            "div",
            { className: "p-6 bg-white rounded-2xl shadow-2xl" },
            React.createElement(
              "h2",
              { className: "text-2xl font-bold mb-4 text-gray-700" },
              "Dashboard (All Bookings)"
            ),
            React.createElement(
              "p",
              { className: "text-sm text-gray-500 mb-4" },
              `User ID: ${userId}`
            ),
            bookings.length > 0 ? (
              React.createElement(
                "div",
                { className: "overflow-x-auto rounded-lg shadow" },
                React.createElement(
                  "table",
                  { className: "min-w-full bg-white border border-gray-200" },
                  React.createElement(
                    "thead",
                    { className: "bg-gray-200" },
                    React.createElement(
                      "tr",
                      null,
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Name"
                      ),
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Email"
                      ),
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Phone"
                      ),
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Date"
                      ),
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Time"
                      ),
                      React.createElement(
                        "th",
                        { className: "py-3 px-6 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider" },
                        "Actions"
                      )
                    )
                  ),
                  React.createElement(
                    "tbody",
                    { className: "divide-y divide-gray-200" },
                    bookings.map((booking) =>
                      React.createElement(
                        "tr",
                        { key: booking.id, className: "hover:bg-gray-50 transition-colors" },
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-left whitespace-nowrap text-sm text-gray-900" },
                          booking.name
                        ),
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-left text-sm text-gray-500" },
                          booking.email
                        ),
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-left text-sm text-gray-500" },
                          booking.phone
                        ),
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-left text-sm text-gray-500" },
                          booking.date
                        ),
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-left text-sm text-gray-500" },
                          booking.time
                        ),
                        React.createElement(
                          "td",
                          { className: "py-4 px-6 text-center" },
                          React.createElement(
                            "div",
                            { className: "flex items-center justify-center space-x-2" },
                            React.createElement(
                              "button",
                              {
                                onClick: () => handleEdit(booking),
                                className: "p-2 bg-yellow-500 text-white rounded-md shadow-md hover:bg-yellow-600 transition-colors"
                              },
                              "Edit"
                            ),
                            React.createElement(
                              "button",
                              {
                                onClick: () => handleDeleteClick(booking.id),
                                className: "p-2 bg-red-600 text-white rounded-md shadow-md hover:bg-red-700 transition-colors"
                              },
                              "Delete"
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            ) : (
              React.createElement(
                "p",
                { className: "text-center text-gray-500 text-lg" },
                "No bookings yet."
              )
            )
          );
        } else if (isLoggedIn && currentView === 'form') {
          return React.createElement(
            "div",
            { className: "p-6 bg-white rounded-2xl shadow-2xl" },
            React.createElement(
              "h2",
              { className: "text-2xl font-bold mb-4 text-gray-700" },
              editingBookingId ? 'Edit Booking' : 'Booking Form'
            ),
            React.createElement(
              "p",
              { className: "text-sm text-gray-500 mb-4" },
              `User ID: ${userId}`
            ),
            React.createElement(
              "form",
              { onSubmit: handleBookingSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-6" },
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "name", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Name"
                ),
                React.createElement("input", {
                  id: "name",
                  type: "text",
                  value: form.name,
                  onChange: (e) => setForm({ ...form, name: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "email", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Email"
                ),
                React.createElement("input", {
                  id: "email",
                  type: "email",
                  value: form.email,
                  onChange: (e) => setForm({ ...form, email: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "phone", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Phone Number"
                ),
                React.createElement("input", {
                  id: "phone",
                  type: "tel",
                  value: form.phone,
                  onChange: (e) => setForm({ ...form, phone: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "date", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Date"
                ),
                React.createElement("input", {
                  id: "date",
                  type: "date",
                  value: form.date,
                  onChange: (e) => setForm({ ...form, date: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "time", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Time"
                ),
                React.createElement("input", {
                  id: "time",
                  type: "time",
                  value: form.time,
                  onChange: (e) => setForm({ ...form, time: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "flex col-span-1 space-x-4" },
                React.createElement(
                  "button",
                  {
                    type: "submit",
                    className: "flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors"
                  },
                  editingBookingId ? 'Update Booking' : 'Add Booking'
                ),
                editingBookingId &&
                React.createElement(
                  "button",
                  {
                    type: "button",
                    onClick: () => {
                      setEditingBookingId(null);
                      setForm({ name: '', email: '', phone: '', date: '', time: '' });
                    },
                    className: "flex-1 p-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-colors"
                  },
                  "Cancel"
                )
              )
            )
          );
        } else if (!isLoggedIn && currentView === 'dashboard') {
          return React.createElement(
            "div",
            { className: "p-6 bg-white rounded-2xl shadow-2xl" },
            React.createElement(
              "h2",
              { className: "text-2xl font-bold mb-4 text-gray-700" },
              "Login to Dashboard"
            ),
            React.createElement(
              "form",
              { onSubmit: handleLogin, className: "flex flex-col gap-4" },
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "username", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Username"
                ),
                React.createElement("input", {
                  id: "username",
                  type: "text",
                  placeholder: "admin",
                  value: username,
                  onChange: (e) => setUsername(e.target.value),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "password", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Password"
                ),
                React.createElement("input", {
                  id: "password",
                  type: "password",
                  placeholder: "12345",
                  value: password,
                  onChange: (e) => setPassword(e.target.value),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                })
              ),
              React.createElement(
                "button",
                {
                  type: "submit",
                  className: "p-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-colors"
                },
                "Login"
              )
            )
          );
        } else {
          return React.createElement(
            "div",
            { className: "p-6 bg-white rounded-2xl shadow-2xl" },
            React.createElement(
              "h2",
              { className: "text-2xl font-bold mb-4 text-gray-700" },
              editingBookingId ? 'Edit Booking' : 'Booking Form'
            ),
            React.createElement(
              "p",
              { className: "text-sm text-gray-500 mb-4" },
              `User ID: ${userId}`
            ),
            React.createElement(
              "form",
              { onSubmit: handleBookingSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-6" },
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "name", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Name"
                ),
                React.createElement("input", {
                  id: "name",
                  type: "text",
                  value: form.name,
                  onChange: (e) => setForm({ ...form, name: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "email", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Email"
                ),
                React.createElement("input", {
                  id: "email",
                  type: "email",
                  value: form.email,
                  onChange: (e) => setForm({ ...form, email: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "phone", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Phone Number"
                ),
                React.createElement("input", {
                  id: "phone",
                  type: "tel",
                  value: form.phone,
                  onChange: (e) => setForm({ ...form, phone: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "date", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Date"
                ),
                React.createElement("input", {
                  id: "date",
                  type: "date",
                  value: form.date,
                  onChange: (e) => setForm({ ...form, date: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "relative" },
                React.createElement(
                  "label",
                  { htmlFor: "time", className: "absolute -top-3 left-2 text-sm text-gray-600 bg-white px-1" },
                  "Time"
                ),
                React.createElement("input", {
                  id: "time",
                  type: "time",
                  value: form.time,
                  onChange: (e) => setForm({ ...form, time: e.target.value }),
                  className: "w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                  required: true
                })
              ),
              React.createElement(
                "div",
                { className: "flex col-span-1 space-x-4" },
                React.createElement(
                  "button",
                  {
                    type: "submit",
                    className: "flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors"
                  },
                  editingBookingId ? 'Update Booking' : 'Add Booking'
                ),
                editingBookingId &&
                React.createElement(
                  "button",
                  {
                    type: "button",
                    onClick: () => {
                      setEditingBookingId(null);
                      setForm({ name: '', email: '', phone: '', date: '', time: '' });
                    },
                    className: "flex-1 p-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-colors"
                  },
                  "Cancel"
                )
              )
            )
          );
        }
      };

      return React.createElement(
        "div",
        { className: "bg-gray-50 min-h-screen p-8 flex flex-col items-center" },
        message &&
        React.createElement(
          "div",
          { className: `fixed top-8 z-50 p-4 rounded-lg shadow-xl text-white font-bold transition-transform duration-300 ${message.type === 'success' ? 'bg-green-600' : 'bg-red-600'} transform -translate-y-full animate-slide-down` },
          message.text
        ),
        showConfirmModal &&
        React.createElement(
          "div",
          { className: "fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center" },
          React.createElement(
            "div",
            { className: "bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full" },
            React.createElement(
              "p",
              { className: "text-lg font-semibold text-gray-800 mb-4" },
              "Are you sure you want to delete this booking?"
            ),
            React.createElement(
              "div",
              { className: "flex justify-center space-x-4" },
              React.createElement(
                "button",
                {
                  onClick: () => setShowConfirmModal(false),
                  className: "px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors"
                },
                "Cancel"
              ),
              React.createElement(
                "button",
                {
                  onClick: handleDeleteConfirm,
                  className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                },
                "Delete"
              )
            )
          )
        ),
        React.createElement(
          "div",
          { className: "w-full max-w-6xl" },
          React.createElement(
            "h1",
            { className: "text-4xl font-extrabold mb-2 text-center text-gray-800" },
            "Appointment Booking System"
          ),
          React.createElement(
            "p",
            { className: "text-lg text-center text-gray-500 mb-6" },
            "Manage your appointments with ease"
          ),
          React.createElement(
            "div",
            { className: "flex justify-center mb-8 space-x-4" },
            React.createElement(
              "button",
              {
                onClick: () => setCurrentView('form'),
                className: `py-2 px-6 rounded-full font-bold transition-colors ${currentView === 'form' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`
              },
              "Booking Form"
            ),
            React.createElement(
              "button",
              {
                onClick: () => setCurrentView('dashboard'),
                className: `py-2 px-6 rounded-full font-bold transition-colors ${currentView === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`
              },
              "Dashboard"
            )
          ),
          renderView()
        )
      );
    }
    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App, null));
  </script>
</body>
</html>
